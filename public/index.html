<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Eventos</title>
    <script src="jquery.min.js"></script>
    <style>
        div.cuadrado {
            position: relative;
            height: 256px;
            width: 256px;
            background-color: lightblue;
        }
        div.punto {
            left: 0px;
            top: 0px;
            height: 8px;
            width: 8px;
            position: absolute;
        }
    </style>
</head>
<body>
    <div class="cuadrado"></div>
    <script>
        var evtSource = new EventSource('https://sheltered-citadel-03188.herokuapp.com/eventos');
        $(document).ready(function(){
            let cuadrado = $('div.cuadrado');
            var urlParams = new URLSearchParams(window.location.search);

            cuadrado.on("click", (e) => {
                let offset = cuadrado.offset();
                $.post("https://sheltered-citadel-03188.herokuapp.com/mover", 
                    {jugador: urlParams.get("jugador"), partida: urlParams.get("partida"), x: e.pageX - offset.left, y: e.pageY - offset.top});
            });

            $(document).keydown((event) => {
                let punto = $('div.punto.' + urlParams.get("jugador"));
                let left = parseInt(punto.css("left").replace("px"));
                let top = parseInt(punto.css("top").replace("px"));
                if (event.which == 37) {
                        $.post("https://sheltered-citadel-03188.herokuapp.com/mover", 
                            {jugador: urlParams.get("jugador"), partida: urlParams.get("partida"), x: left-8, y: top});
                    }
                    else if (event.which == 39) {
                        $.post("https://sheltered-citadel-03188.herokuapp.com/mover", 
                            {jugador: urlParams.get("jugador"), partida: urlParams.get("partida"), x: left+8, y: top});
                    }
            });
                
            evtSource.onopen = function(e) {console.log("open")};
            evtSource.onerror = function(e) {console.error(e)};
            evtSource.onmessage = function(e) {
                const datos = JSON.parse(e.data);
                datos.forEach((punto) => {
                    let divPunto = $('div.punto.' + punto.jugador);
                    if (divPunto.length == 0) {
                        cuadrado.append("<div class='punto {jugador}' />".replace("{jugador}", punto.jugador));
                        divPunto = $('div.punto.' + punto.jugador);
                        divPunto.css("background-color", punto.jugador);
                    }
                    divPunto.css("left", punto.x + "px");
                    divPunto.css("top", punto.y + "px");
                });
            }
        });
    </script>
</body>
</html>