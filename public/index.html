<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Eventos</title>
    <script src="//code.jquery.com/jquery-1.11.3.min.js"></script>
    <style>
        div.cuadrado {
            position: relative;
            height: 256px;
            width: 256px;
            background-color: lightblue;
        }
        div.punto {
            left: 0px;
            top: 0px;
            height: 8px;
            width: 8px;
            position: absolute;
        }
    </style>
</head>
<body>
    <div class="cuadrado"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        $(document).ready(function() {
            let bola = null
            let socket = io();
            socket.on('puntos', function(data) {
                data.forEach((punto) => {
                    let divPunto = $('div.punto.' + punto.jugador);
                    if (divPunto.length == 0) {
                        cuadrado.append("<div class='punto {jugador}' />".replace("{jugador}", punto.jugador));
                        divPunto = $('div.punto.' + punto.jugador);
                        divPunto.css("background-color", punto.jugador);
                    }
                    divPunto.css("left", punto.x + "px");
                    divPunto.css("top", punto.y + "px");
                    if (punto.jugador == "white") {
                        clearTimeout(bola);
                        bola = setInterval(() => {
                            let puntoBlanco = $('div.punto.white');
                            let top = parseInt(puntoBlanco.css("top").replace("px"));
                            puntoBlanco.css("top", "" + (top + 4) + "px");
                        }, 1000/60)
                    }
                });
            })

            let mover = function(jugador, partida, x, y) {
                socket.emit('punto', {jugador: jugador, partida: partida, x: x, y: y});
            }

            let cuadrado = $('div.cuadrado');
            let urlParams = new URLSearchParams(window.location.search);

            cuadrado.on("click", (e) => {
                let offset = cuadrado.offset();
                mover(urlParams.get("jugador"), urlParams.get("partida"), e.pageX - offset.left, e.pageY - offset.top);
            });

            $(document).keydown((event) => {
                let punto = $('div.punto.' + urlParams.get("jugador"));
                let left = parseInt(punto.css("left").replace("px"));
                let top = parseInt(punto.css("top").replace("px"));
                if (event.which == 37) {
                    mover(urlParams.get("jugador"), urlParams.get("partida"), left-8, top);
                }
                else if (event.which == 39) {
                    mover(urlParams.get("jugador"), urlParams.get("partida"), left+8, top);
                }
            });
            
        });
    </script>
</body>
</html>